# 変更履歴 v2.10.17

## 修正内容

### 🐛 バグ修正: 北海道カテゴリ無限ループ

**問題:**
北海道エリアを選択後、北海道のエリア選択で再び北海道を選択すると、無限ループが発生していました。

**原因:**
- 北海道カテゴリが自分自身を子カテゴリとして持っていた（循環参照）
- `hasChildren: true`フラグにより、同じカテゴリを繰り返し読み込んでいた

**修正内容:**

#### 1. フロントエンド (toppage.js)
- **バージョン番号**: v2.10.17に更新
- **循環参照検出**: 親カテゴリと子カテゴリが同じ場合を検出し、タグ読み込みに進む
- **カテゴリスタック**: `categoryStack`配列を追加し、訪問済みカテゴリを追跡
- **無限ループ防止**: スタック内に既に存在するカテゴリの場合、アラートを表示
- **階層制限**: カテゴリ階層が3レベルを超える場合、強制的にタグ選択に進む
- **詳細ログ**: すべてのログに`[v2.10.17]`プレフィックスを追加

#### 2. バックエンド (class-ajax-handler.php)
- **hasChildren判定**: 各子カテゴリに`hasChildren`プロパティを追加
- **循環参照チェック**: 親と子が同じslugの場合、`hasChildren`をfalseに設定
- **エラーログ**: 循環参照検出時にWordPressエラーログに記録
- **パフォーマンス最適化**: `fields => 'ids'`と`number => 1`で高速化

#### 3. プラグインメタデータ (umaten-toppage.php)
- バージョン: 2.8.3 → 2.10.17
- 説明文に修正内容を追加

## テスト推奨事項

1. ✅ 北海道エリアを選択 → 北海道を選択 → タグ選択画面に進むことを確認
2. ✅ 他の地域（東北、関東など）が正常に動作することを確認
3. ✅ ブラウザのコンソールで`[v2.10.17]`ログを確認
4. ✅ 循環参照が検出された場合、適切なエラーメッセージが表示されることを確認

## 影響範囲

- **低リスク**: 既存の動作は維持しつつ、循環参照のみを防止
- **互換性**: 他の地域や正常なカテゴリ階層には影響なし
- **パフォーマンス**: 若干の改善（hasChildrenチェックの最適化）

## 次のステップ

このプラグインをWordPressにアップロードし、北海道エリアで動作を確認してください。
