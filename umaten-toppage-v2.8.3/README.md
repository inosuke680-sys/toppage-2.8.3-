# Umaten トップページプラグイン v2.9.5 - 最終完全版

## バージョン情報

- **現在のバージョン**: v2.9.5
- **ベースバージョン**: v2.9.4
- **リリース日**: 2025年11月16日
- **デザインレベル**: 予算80万円相当のプレミアムUI（視認性改善・最終完全版）

## v2.9.5の変更点

**restaurant-review-category-tagsの rrct_active フラグを尊重（カテゴリ+タグアーカイブページが正常動作）**

### 重大バグ修正

1. **v2.9.4の誤判定問題を修正**
   - **問題**: v2.9.4で、`restaurant-review-category-tags`が意図的に設定した`category_name`と`tag`を「WordPress標準クエリ」と誤認し、`rrct_*`クエリ変数をクリアしてしまう
     - 結果: `/hokkaido/hakodate/ramen/` がトップページにリダイレクト
     - 原因: `handle_plugin_conflicts()`が`category_name`や`tag`が設定されている=WordPress標準と判断
   - **解決策**: `rrct_active`フラグをチェックし、`restaurant-review-category-tags`が意図的に処理中の場合は何もしない
   ```php
   // 【v2.9.5修正】rrct_activeフラグがある場合、restaurant-review-category-tagsが意図的に処理中
   // この場合は何もしない（category_nameとtagはプラグインが意図的に設定したもの）
   if (get_query_var('rrct_active')) {
       return;
   }
   ```
   - **影響**: カテゴリ+タグアーカイブページが正常に動作し、すべてのプラグイン機能が完全に共存

### コード変更

**修正ファイル**: `includes/class-url-rewrite.php`
- `handle_plugin_conflicts()`メソッドに`rrct_active`フラグのチェックを追加（91-95行目）
- WordPress標準クエリチェックの前に、`restaurant-review-category-tags`の意図的な処理かどうかを確認

**修正ファイル**: `umaten-toppage.php`
- バージョンを`2.9.5`に更新
- プラグイン説明を更新: rrct_activeフラグの尊重を明記

### 動作確認項目

デプロイ後、以下を確認してください:
1. **投稿ページが正常に表示される**
   - 例: `https://umaten.jp/hokkaido/menya-kagetsu-hakodate-kikyo-2/`
   - 記事の内容が正しく表示される
2. **カテゴリ+タグアーカイブページが正常に動作**  ← **v2.9.5で修正**
   - 例: `https://umaten.jp/hokkaido/hakodate/ramen/`
   - 函館のラーメン記事が正しく表示される
   - トップページにリダイレクトされない
3. **検索ウィジェットの機能が正常に動作**
   - `umaten-restaurant-search-widget`のカスタムアーカイブページが正常に表示される
4. **WordPress標準のアーカイブページが正常に表示**
   - カテゴリアーカイブ、タグアーカイブが正常に表示される

### 対応プラグイン一覧

v2.9.5では、以下のプラグインとの衝突を自動的に回避します:
- ✅ **umaten-restaurant-search-widget** (v2.9.2以降で対応)
- ✅ **restaurant-review-category-tags** (v2.9.4で新規対応、v2.9.5で完全修正)

## v2.9.4の変更点

**複数プラグインとの衝突を完全に回避（すべてのプラグインが共存可能）**

### 重大機能追加・バグ修正

1. **restaurant-review-category-tagsプラグインとの衝突も回避**
   - **問題**: `restaurant-review-category-tags`プラグインが追加する広範囲なリライトルールが、投稿ページやWordPress標準のタクソノミーアーカイブと衝突
     - プラグインが追加するルール:
       - 3階層: `^([^/]+)/([^/]+)/([^/]+)/?$` → `rrct_parent_category`/`rrct_child_category`/`rrct_tag`
       - 2階層: `^([^/]+)/([^/]+)/?$` → `rrct_category`/`rrct_tag`
     - 優先度 `top` で最優先されるため、WordPress標準ルールより先に処理される
     - 結果: 投稿ページ（例: `/hokkaido/menya-kagetsu-hakodate-kikyo-2/`）がカテゴリ+タグページとして誤認識される
   - **原因**: `umaten-restaurant-search-widget`と同様の設計で、広範囲なリライトルールを追加
   - **解決策**: `handle_plugin_conflicts()`メソッドを拡張し、以下のプラグインすべてのクエリ変数をクリア
     - **umaten-restaurant-search-widget**: `umaten_region`, `umaten_area`, `umaten_genre`
     - **restaurant-review-category-tags**: `rrct_category`, `rrct_parent_category`, `rrct_child_category`, `rrct_tag`, `rrct_active`
   - **影響**: 3つのプラグインすべてが共存可能になり、すべての機能が正常に動作

2. **メソッド名を変更してより汎用的に**
   - `handle_search_widget_conflict()` → `handle_plugin_conflicts()`
   - 複数のプラグインとの衝突を一元管理

### コード変更

**修正ファイル**: `includes/class-url-rewrite.php`
- メソッド名変更: `handle_search_widget_conflict()` → `handle_plugin_conflicts()`
- `handle_plugin_conflicts()`メソッドを拡張:
  - `umaten-restaurant-search-widget`のクエリ変数検出: `umaten_region`, `umaten_area`, `umaten_genre`
  - `restaurant-review-category-tags`のクエリ変数検出: `rrct_category`, `rrct_parent_category`, `rrct_child_category`, `rrct_tag`, `rrct_active`
  - WordPress標準のクエリが存在する場合、両プラグインのクエリ変数をクリア
  - デバッグログで衝突回避を記録（クリアされたプラグイン名も表示）

**修正ファイル**: `umaten-toppage.php`
- バージョンを`2.9.4`に更新
- プラグイン説明を更新: 両プラグインとの共存を明記

### 動作確認項目

デプロイ後、以下を確認してください:
1. **投稿ページが正常に表示される**
   - 例: `https://umaten.jp/hokkaido/menya-kagetsu-hakodate-kikyo-2/`
   - 記事の内容が正しく表示される
   - カテゴリ+タグページとして誤認識されない
2. **ジャンルアーカイブページが正常に動作**
   - エリア選択 → 子カテゴリ選択 → ジャンル選択
   - 該当ジャンルのアーカイブページが正しく表示される
3. **検索ウィジェットの機能が正常に動作**
   - `umaten-restaurant-search-widget`の検索機能が問題なく動作する
   - カスタムアーカイブページ（例: `/hokkaido/niseko/ramen/`）が正常に表示される
4. **restaurant-review-category-tagsの機能が正常に動作**
   - カテゴリ+タグの組み合わせページが正常に表示される
   - 親カテゴリ+子カテゴリ+タグの組み合わせページが正常に表示される
5. **WordPress標準のアーカイブページが正常に表示**
   - カテゴリアーカイブ、タグアーカイブが正常に表示される

### 対応プラグイン一覧

v2.9.4では、以下のプラグインとの衝突を自動的に回避します:
- ✅ **umaten-restaurant-search-widget** (v2.9.2以降で対応)
- ✅ **restaurant-review-category-tags** (v2.9.4で新規対応)

## v2.9.3の変更点

**検索ウィジェットとの衝突回避ロジックを修正（カスタムアーカイブページも正常動作）**

### 重大バグ修正

1. **v2.9.2の過剰な条件判定を修正**
   - **問題**: v2.9.2で追加した`is_archive()`条件が広すぎて、検索ウィジェットが作成するカスタムアーカイブページ（例: `/hokkaido/niseko/ramen/`）でもクエリ変数がクリアされてしまう
     - 結果: ニセコのラーメンページで函館のラーメンが表示される
     - 記事をクリックしてもトップページに戻る、またはカテゴリページに遷移する
   - **原因**: `is_archive()`は検索ウィジェットのカスタムアーカイブページでも`true`を返すため、必要なクエリ変数までクリアされる
   - **解決策**: WordPress標準のクエリ変数（`name`, `category_name`, `tag`など）が**実際に設定されている場合のみ**、検索ウィジェットのクエリ変数をクリア
     - `is_archive()`などの条件判定を削除
     - 代わりに、`get_query_var('name')`, `get_query_var('category_name')`などの具体的なクエリ変数の存在を確認
     - WordPress標準のタクソノミー（`region`, `area`, `genre`）も確認
   - **影響**: 検索ウィジェットのカスタムアーカイブページが正常に動作し、投稿ページも正常に表示される

### コード変更

**修正ファイル**: `includes/class-url-rewrite.php`
- `handle_search_widget_conflict()`メソッドを修正:
  - `is_archive()`, `is_singular()`, `is_category()`などの条件判定を削除
  - WordPress標準のクエリ変数が実際に設定されているかを確認する方式に変更:
    - `get_query_var('name')` - 投稿名
    - `get_query_var('pagename')` - ページ名
    - `get_query_var('category_name')` - カテゴリ名
    - `get_query_var('tag')` - タグ
    - `get_query_var('region')`, `get_query_var('area')`, `get_query_var('genre')` - カスタムタクソノミー
  - これらが設定されている場合のみ、検索ウィジェットのクエリ変数をクリア

### 動作確認項目

デプロイ後、以下を確認してください:
1. **検索ウィジェットのカスタムアーカイブページが正常に動作**
   - 例: `https://umaten.jp/hokkaido/niseko/ramen/` → ニセコのラーメンが表示される
   - 例: `https://umaten.jp/hokkaido/hakodate/ramen/` → 函館のラーメンが表示される
2. **投稿ページが正常に表示される**
   - 例: `https://umaten.jp/hokkaido/menya-kagetsu-hakodate-kikyo-2/`
   - 記事の内容が正しく表示される
3. **記事をクリックしても正常に遷移**
   - トップページやカテゴリページに誤って遷移しない
4. **WordPress標準のアーカイブページが正常に表示**
   - カテゴリアーカイブ、タグアーカイブが正常に表示される

## v2.9.2の変更点

**umaten-restaurant-search-widgetプラグインとの衝突を回避（両プラグインが共存可能）**

### 重大バグ修正

1. **umaten-restaurant-search-widgetとの衝突を解決**
   - **問題**: `umaten-restaurant-search-widget`プラグインが追加する広範囲なリライトルールが、投稿ページやWordPress標準のタクソノミーアーカイブと衝突
     - プラグインが追加するルール: `^([^/]+)/([^/]+)/([^/]+)/?$` (3階層), `^([^/]+)/([^/]+)/?$` (2階層), `^([^/]+)/?$` (1階層)
     - これらが投稿URL (`/hokkaido/menya-kagetsu-hakodate-kikyo-2/`) やジャンルアーカイブとマッチ
     - 結果: ジャンルタグをクリックするとトップページにリダイレクト
   - **原因**: 両プラグインが同時にURLを処理しようとして衝突
   - **解決策**: `template_redirect`フックを優先度1で追加し、WordPress標準のクエリを優先
     - WordPress標準のクエリ（投稿、カテゴリ、タグ、アーカイブなど）が存在する場合、検索ウィジェットのクエリ変数をクリア
     - これにより、投稿ページとタクソノミーアーカイブが正常に表示される
     - 検索ウィジェットの機能も維持される
   - **影響**: 両プラグインが共存可能になり、すべての機能が正常に動作

### コード変更

**修正ファイル**: `includes/class-url-rewrite.php`
- コンストラクタ: `handle_search_widget_conflict()`メソッドを優先度1で登録
- 新規メソッド `handle_search_widget_conflict()`:
  - `umaten_region`/`umaten_area`/`umaten_genre`クエリ変数を検出
  - WordPress標準のクエリ（is_singular, is_category, is_tag等）が存在する場合、検索ウィジェットのクエリ変数をクリア
  - デバッグログで衝突回避を記録

### 動作確認項目

デプロイ後、以下を確認してください:
1. **投稿ページが正常に表示される**
   - 例: `https://umaten.jp/hokkaido/menya-kagetsu-hakodate-kikyo-2/`
   - 記事の内容が正しく表示される
2. **ジャンルタグをクリックしてもリダイレクトされない**
   - エリア選択 → 子カテゴリ選択 → ジャンル選択
   - 該当ジャンルのアーカイブページが正しく表示される
   - トップページにリダイレクトされない
3. **検索ウィジェットの機能が正常に動作**
   - `umaten-restaurant-search-widget`の検索機能が問題なく動作する
4. **WordPress標準のアーカイブページが正常に表示**
   - カテゴリアーカイブ、タグアーカイブが正常に表示される

## v2.9.1の変更点

**カスタムリライトルールを削除（投稿ページ表示バグ修正）**

### 重大バグ修正

1. **投稿ページが表示されない問題を修正**
   - **問題**: v2.8.8以降、投稿ページ（例: `/hokkaido/menya-kagetsu-hakodate-kikyo-2/`）にアクセスしても記事が表示されない
   - **原因**: v2.8.8で追加したカスタムリライトルール `^([^/]+)/([^/]+)/?$` が投稿ページのURLにも誤ってマッチ
     - 投稿URL `/hokkaido/menya-kagetsu-hakodate-kikyo-2/` が `umaten_parent=hokkaido`, `umaten_child=menya-kagetsu-hakodate-kikyo-2` として処理される
     - カスタムハンドラーが投稿を正しく表示できない
   - **解決策**: カスタムリライトルールを完全に削除
     - `add_rewrite_rules()` メソッド削除
     - `add_query_vars()` メソッド削除
     - `handle_custom_request()` メソッド削除
     - コンストラクタから関連する登録を削除
   - **影響**: 投稿ページが正常に表示されるようになる
   - **注意**: v2.9.0で「すべてのジャンル」機能を削除済みのため、カスタムリライトルールは不要

### コード変更

**修正ファイル**: `includes/class-url-rewrite.php`
- コンストラクタ: カスタムリライトルール関連の登録を削除、404ハンドラーのみ残す
- `add_rewrite_rules()` メソッド: 削除（約15行）
- `add_query_vars()` メソッド: 削除（約6行）
- `handle_custom_request()` メソッド: 削除（約80行）
- `flush_rewrite_rules()` メソッド: 通常のフラッシュのみに変更

### 動作確認項目

デプロイ後、以下を確認してください:
1. **投稿ページが正常に表示される**
   - 例: `https://umaten.jp/hokkaido/menya-kagetsu-hakodate-kikyo-2/`
   - 記事の内容が正しく表示される
2. **ジャンルアーカイブページが正常に動作**
   - エリア選択 → 子カテゴリ選択 → ジャンル選択
   - 該当ジャンルの記事一覧が表示される
3. **404ハンドラーが正常に動作**
   - 存在しないURLにアクセスした場合、適切に404ページが表示される

## v2.9.0の変更点

**「すべてのジャンル」ボタンを削除（リダイレクトバグの暫定対応）**

### 機能削除

1. **「すべてのジャンル」ボタンの削除**
   - **背景**: v2.8.8でカスタムリライトルールを追加したにも関わらず、リダイレクトバグが解決しなかった
   - **対応**: リダイレクトバグの原因となっていた「すべてのジャンル」ボタンを削除
   - **影響**: ユーザーは特定のジャンル（タグ）を選択してアーカイブページに遷移する必要がある
   - **v2.9.1での追加修正**: カスタムリライトルールも削除（投稿ページ表示バグ修正）

## v2.8.8の変更点

**カスタムリライトルール追加を試みた（結果として投稿ページ表示バグを引き起こす）**

### バグ修正の試み（v2.9.1で完全に削除）

1. **カスタムリライトルールを追加**（結果として新たなバグを引き起こした）
   - **問題**: v2.8.7でも `/親/子/` URL（例: `https://umaten.jp/hokkaido/hakodate/`）がトップページにリダイレクトされる
   - **試みた解決策**: WordPressのリライトルール機能を使用して、カスタムURLパターンを登録
   - **結果**: リダイレクトバグは解決せず、投稿ページが表示されない新たなバグを引き起こす
   - **v2.9.0での対応**: 「すべてのジャンル」ボタンを削除
   - **v2.9.1での対応**: カスタムリライトルールを完全に削除

### デザイン改善

2. **サイト説明セクションの視認性改善と統一感強化**
   - **背景とコントラストの改善**
     - 背景の透明度を調整（0.98 → 1.0）でより明瞭に
     - ラディアルグラデーションの強度を減少（0.08 → 0.04）
     - backdrop-filterのぼかしを適度に調整（30px → 15px）
   - **テキストの読みやすさ向上**
     - 本文テキストの色を濃く（#2c3e50 → #1a202c）
     - フォントサイズを適切に調整（19px → 17px、26px → 24px）
     - 見出しをグラデーションテキストからソリッドカラーに変更（視認性向上）
     - アニメーションを控えめに（グラデーションシフト削除）
   - **アニメーションの最適化**
     - フローティングアニメーションの振幅を減少（-8px → -3px）
     - アニメーション周期を延長（12s → 18s）でより穏やかに
     - パルス効果の強度を減少（opacity 0.5-0.8 → 0.4-0.6）
     - シマーエフェクトを削除（過度な視覚効果を抑制）
   - **特徴アイテムの改善**
     - 背景を明瞭に（透明度を調整）
     - ホバー時の動きを控えめに（-12px → -6px）
     - アイコンサイズを適切に（56px → 48px）
     - アイコンアニメーションを簡略化（回転角度を減少）
     - 見出しの色をソリッドカラーに（視認性向上）
     - ホバー時に見出し色が変化（#2d3748 → #667eea）
   - **統一感の強化**
     - ヒーローセクションや統計バーとの色調を統一
     - ボーダーとシャドウのスタイルを統一
     - トランジション速度を統一（0.3s - 0.4s）

### コード品質改善

3. **URLリライトシステムの強化**
   - デバッグログに v2.8.8 タグを追加
   - カスタムリライトルールの登録を明示化
   - フォールバック処理として404ハンドラーを維持

## v2.8.7の変更点

**ジャンル選択バグの部分修正 + サイト説明セクションのプレミアムデザイン実装**

### バグ修正（v2.8.8で根本解決）

1. **ジャンル選択時のURL検証バグを修正（v2.8.8で更に改善）**
   - 問題: エリアと子カテゴリを選択後、「すべてのジャンル」をクリックすると「URLエラー」が表示される
   - v2.8.7での修正: URL検証時に `https://` プロトコル部分の `//` を誤って重複スラッシュとして検知する問題を修正
   - v2.8.8での改善: カスタムリライトルール追加により根本的に解決

### サイト説明セクション - 80万円プレミアムデザイン実装

2. **サイト説明セクションを完全にリニューアル**
   - **アニメーション効果の大幅強化**
     - ラディアルグラデーション + 複雑な背景レイヤー
     - フローティングアニメーション（`aboutFloat` - 12秒周期）
     - パルス効果で中央に光の呼吸エフェクト（8秒周期）
     - グラデーションボーダーのスライドアニメーション（8秒周期）
     - テキストグラデーションシフト（6秒周期）

   - **グラスモーフィズム強化**
     - backdrop-filter: blur(30px) saturate(180%)
     - 半透明背景 + 多重グラデーションレイヤー
     - 6層の多重ボックスシャドウ（外側・内側・発光）
     - グラデーション境界線（3px、3色ブレンド）

   - **特徴アイテムの高度なインタラクション**
     - 3Dトランスフォーム（translateY + translateX + scale）
     - シマーエフェクト（光の反射アニメーション）
     - アイコンフローティング + バウンスアニメーション
     - ホバー時の複雑な影のトランジション（elastic easing）
     - 6px幅のグラデーション左ボーダー（4色）+ グロー効果

   - **タイポグラフィ強化**
     - メインテキスト: 4色グラデーション + アニメーション
     - 見出し: グラデーションテキストクリップ + 位置シフト
     - アイコン: 56px、多重ドロップシャドウ、回転 + スケールアニメーション
     - テキストシャドウ + レタースペーシング調整

### コード品質改善

3. **JavaScript デバッグログの改善**
   - 全てのログメッセージを `[v2.8.7]` タグに更新
   - URL検証の詳細ログ追加（プロトコル除外前後の状態を記録）

## v2.8.6の変更点

**令和的な大規模DBサイトとしてのプレミアムデザイン実装**

### デザイン刷新（予算80万円レベルの実装）

1. **ヒーローセクションの大幅改善**
   - 複雑なグラデーションアニメーション（5色のグラデーション + 色相回転）
   - レディアルグラデーションによる光の効果
   - テキストグラデーションクリップ効果
   - 高さを700pxに拡大、より壮大な印象に
   - 多重影・発光エフェクト

2. **統計バー - グラスモーフィズムデザイン**
   - backdrop-filter によるぼかし効果
   - 半透明背景 + 境界線の光沢効果
   - ホバー時の3Dトランスフォーム
   - テキストグラデーションクリップ
   - 多重ボックスシャドウによる立体感
   - レスポンシブなグリッドレイアウト強化

3. **検索バー - プレミアム仕様**
   - グラスモーフィズム効果（backdrop-filter: blur(20px)）
   - 多重ボックスシャドウ（外側・内側・発光）
   - インタラクティブなホバーアニメーション
   - 3色グラデーションボタン
   - ボーダーハイライト効果

4. **サイト説明セクション - 高級感のあるデザイン**
   - グラデーションボーダートップ（5色）
   - グラスモーフィズム背景
   - ホバー時の左ボーダーアニメーション
   - アイコンの拡大・回転エフェクト
   - テキストグラデーションクリップ
   - 立体的な影効果

5. **全体的な改善**
   - より洗練されたカラーパレット（#667eea, #764ba2, #ed4264系）
   - タイポグラフィの強化（フォントサイズ・ウェイト最適化）
   - cubic-bezier イージング関数による滑らかなアニメーション
   - レスポンシブデザインの完全対応

### バグ修正

6. **ジャンル「すべて」選択時のリダイレクトバグ修正**
   - URL生成前に currentParentSlug と currentChildSlug を検証
   - 不正なURL（空文字・重複スラッシュ）を検出してエラー表示
   - デバッグログの強化（v2.8.6タグ付き）
   - クリック時の最終URLチェック機能追加

## v2.8.5の変更点

**UI改善とコンテンツ管理機能の強化**

### 主な変更内容

1. **人気のジャンルセクションを削除 → サイト説明セクションに変更**
   - ユーザーにとってより有益な情報として、サイトの特徴や機能を説明するセクションに刷新
   - 全国対応、信頼できる口コミ、簡単検索の3つの特徴を明確に表示

2. **「エリアから探す」を「掲載店舗エリア」に変更**
   - より直感的でわかりやすい表記に改善

3. **月間アクセス数の手動入力機能を追加**
   - 管理画面から月間アクセス数を手動で入力可能に
   - 入力された数値は自動的にカンマ区切りで表示され、「+」が付加される
     - 例: 管理画面で「1500」と入力 → 表示は「1,500+」
   - 手動入力値が優先され、空欄の場合は自動計算値を使用
   - WordPress管理画面 → トップページ設定 → 月間アクセス数設定から入力

### 新機能詳細

#### サイト説明セクション
- サイトの概要と3つの主要機能を視覚的に表示
- アイコン付きの分かりやすいレイアウト
- ユーザーの理解を促進する情報設計

#### 月間アクセス数管理
- 管理画面から簡単に設定可能
- 数値のみを入力（カンマ不要）
- 表示時に自動フォーマット（カンマ区切り + 「+」記号）
- 優先順位: 手動入力 > ビューカウンター > 統計プラグイン > 推定値

## v2.8.3の変更点

**SEOに強い実装**：アイキャッチ画像を設定してSEO効果を最大化しつつ、記事ページでは完全に非表示にします。

### 記事ページでのアイキャッチ完全非表示（3段階フィルター）

v2.8.2では`post_thumbnail_html`フィルターのみでしたが、SWELLテーマなどが独自の方法でアイキャッチを取得する場合に対応するため、3段階のフィルターで完全にブロックします。

```
記事ページでのアイキャッチ取得をブロック:

レベル1: post_thumbnail_html
  → アイキャッチHTMLを空文字に

レベル2: has_post_thumbnail
  → has_post_thumbnail()をfalseに

レベル3: get_post_metadata (_thumbnail_id)
  → get_post_meta()で_thumbnail_idを空に
```

テーマがどんな方法でアイキャッチを取得しようとしても、記事ページでは常に「アイキャッチなし」として扱われます。

### SEO効果を維持

アイキャッチ画像は設定されているため、以下のSEO効果があります：

- **OGP（og:image）**: TwitterやFacebookなどでシェア時に画像が表示される
- **構造化データ（Schema.org）**: 検索エンジンが記事の画像を認識
- **Google検索結果**: 検索結果に画像が表示される
- **一覧ページ**: カテゴリ、タグ、アーカイブページでサムネイル表示

## インストール方法

### 自動デプロイ

```bash
curl -o /tmp/deploy-v2.8.3.sh https://raw.githubusercontent.com/inosuke680-sys/toppage-WP-INSIDE-/claude/plugin-v2.6.0-upgrade-015K3j6rBvErzVhU5LxoG5Vj/deploy-production-v2.8.3.sh
chmod +x /tmp/deploy-v2.8.3.sh
sudo /tmp/deploy-v2.8.3.sh
```

### プラグイン有効化

WordPress管理画面 → プラグイン:
1. 既存のUmatenプラグイン（v2.8.2など）を無効化
2. 「Umaten トップページ v2.8.3」を有効化
3. **重要**: 設定 → パーマリンク → 「変更を保存」

### 既存投稿へのアイキャッチ設定

v2.8.2と同じスクリプトを使用できます：

```bash
cd /home/kusanagi/45515055731ac663c7c3ad4c/DocumentRoot && \
curl -o bulk-set-hero-images-v2.8.2.php https://raw.githubusercontent.com/inosuke680-sys/toppage-WP-INSIDE-/claude/plugin-v2.6.0-upgrade-015K3j6rBvErzVhU5LxoG5Vj/bulk-set-hero-images-v2.8.2.php && \
php bulk-set-hero-images-v2.8.2.php
```

## 動作確認

### ✓ 確認1: 一覧ページでアイキャッチが表示される

カテゴリページやタグページで、アイキャッチ画像が表示されることを確認してください。

### ✓ 確認2: 記事ページでアイキャッチが重複しない

記事ページで、本文中のヒーロー画像のみが表示され、アイキャッチ画像が重複表示されないことを確認してください。

### ✓ 確認3: SEO要素が正常

- ブラウザの開発者ツールで`<meta property="og:image">`タグにアイキャッチ画像のURLが設定されていることを確認
- TwitterやFacebookのシェアプレビューツールで画像が表示されることを確認

## 技術仕様

### 3段階フィルターの仕組み

```php
// レベル1: HTMLを空文字にする
add_filter('post_thumbnail_html', 'hide_thumbnail_on_single', 10, 5);

// レベル2: has_post_thumbnail()をfalseにする
add_filter('has_post_thumbnail', 'disable_thumbnail_check_on_single', 10, 2);

// レベル3: get_post_metadata()で_thumbnail_idを空にする
add_filter('get_post_metadata', 'hide_thumbnail_id_on_single', 10, 4);
```

これにより、SWELLテーマが以下のどの方法でアイキャッチを取得しようとしても、記事ページでは空になります：

- `the_post_thumbnail()` → レベル1でブロック
- `has_post_thumbnail()` → レベル2でブロック
- `get_post_thumbnail_id()` → レベル3でブロック
- `get_post_meta($post_id, '_thumbnail_id')` → レベル3でブロック

### SEO要素は影響を受けない

以下のSEO要素は正常に動作します：

- OGPタグの生成（多くのプラグインは`wp_head`アクション内で生成するため、フィルターの影響を受けない）
- Schema.org構造化データ（同様に`wp_head`で生成）
- XMLサイトマップ（管理画面やサイトマップ生成時は`is_single()`がfalseのため）

## トラブルシューティング

### 記事ページでアイキャッチが表示されてしまう場合

v2.8.3では3段階フィルターで完全にブロックしていますが、もし表示される場合は：

1. テーマが独自のカスタムフィールドでアイキャッチを保存している可能性があります
2. キャッシュをクリアしてください（ブラウザ、WordPress、CDN）
3. デバッグログを確認してください

### OGP画像が表示されない場合

1. 使用しているSEOプラグイン（Yoast、All in One SEO等）の設定を確認
2. テーマがOGPタグを生成している場合、設定を確認
3. ブラウザの開発者ツールで`<meta property="og:image">`タグが存在するか確認

## v2.8.2からの変更点

- v2.8.2: `post_thumbnail_html`フィルターのみ
- **v2.8.3**: 3段階フィルター（post_thumbnail_html + has_post_thumbnail + get_post_metadata）

より確実に記事ページでアイキャッチを非表示にできます。

## v2.8.3の設計思想

**SEO効果を最大化しつつ、重複を完全に防止**

- アイキャッチを設定してSEO効果を維持（OGP、Schema.org、検索結果）
- 記事ページでは3段階フィルターで完全にブロック（重複回避）
- v2.8.2の安定性を維持したシンプル実装
- SWELLテーマとの完全な互換性

## ライセンス

GPL v2 or later

## 開発者

Umaten - https://umaten.jp
